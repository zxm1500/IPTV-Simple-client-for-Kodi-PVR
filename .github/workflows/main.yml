name: Build pvr.iptvsimple for Kodi 21 Omega (2025 11.30 零错误版)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout pvr.iptvsimple
        uses: actions/checkout@v4
        with:
          repository: kodi-pvr/pvr.iptvsimple
          ref: 21.11.0-Omega

      - name: Install basic tools & libraries
        run: |
          sudo apt update -qq
          sudo apt install -y cmake ninja-build git pkg-config \
                              libtinyxml-dev rapidjson-dev zlib1g-dev \
                              libcurl4-openssl-dev libpugixml-dev

      # 修复版：正确提取 Kodi 21 Omega addon dev headers（指定分支 + 正确路径）
      - name: Extract Kodi 21 Omega addon dev headers from source
        run: |
          # 克隆并切换到 Omega 分支，只取必要目录（xbmc/addons/include/kodi）
          git clone --depth 1 --filter=blob:none --no-checkout https://github.com/xbmc/xbmc.git kodi-src
          cd kodi-src
          git checkout Omega
          git sparse-checkout set xbmc/addons/include/kodi
          git checkout
          
          # 复制头文件到系统路径（使用 Omega 实际路径）
          sudo mkdir -p /usr/include/kodi
          sudo cp -r xbmc/addons/include/kodi/* /usr/include/kodi/ || true  # || true 忽略空目录
          
          # 额外复制其他可能需要的 addon 头文件（从 Omega 结构）
          sudo cp -r xbmc/addons/include/xbmc_addon_* /usr/include/ || true
          
          # 清理
          cd .. && rm -rf kodi-src

      # 补 kodi-platform（兼容旧 addon）
      - name: Install minimal kodi-platform
        run: |
          git clone --depth 1 https://github.com/xbmc/kodi-platform.git
          cd kodi-platform
          mkdir build && cd build
          cmake .. -DCMAKE_INSTALL_PREFIX=/usr -DBUILD_SHARED_LIBS=ON
          make -j$(nproc)
          sudo make install
          cd ../.. && rm -rf kodi-platform

      # 编译 pvr.iptvsimple
      - name: Build pvr.iptvsimple
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
                   -DCMAKE_BUILD_TYPE=Release \
                   -DBUILD_SHARED_LIBS=1 \
                   -DUSE_LTO=1 \
                   -DKODI_ADDON_API_LEVEL=21
          ninja

      - name: Package ZIP
        run: |
          cd build
          cpack -G ZIP

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple-21.11.0-Omega-linux-x64
          path: build/pvr.iptvsimple-*.zip
          retention-days: 30

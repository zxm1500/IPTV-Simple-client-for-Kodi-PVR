name: Build pvr.iptvsimple - Latest Stable Release (zip only)

on:
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:

      - name: Get latest stable release tag
        id: latest_tag
        run: |
          TAG=$(curl -s https://api.github.com/repos/kodi-pvr/pvr.iptvsimple/releases/latest \
                | jq -r '.tag_name')
          echo "Latest stable release: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Checkout Kodi Omega
        uses: actions/checkout@v4
        with:
          repository: xbmc/xbmc
          ref: Omega
          path: xbmc

      - name: Checkout pvr.iptvsimple latest stable release
        uses: actions/checkout@v4
        with:
          repository: kodi-pvr/pvr.iptvsimple
          ref: ${{ steps.latest_tag.outputs.tag }}
          path: pvr.iptvsimple

      - name: Install build dependencies
        run: sudo apt update -qq && sudo apt install -y build-essential cmake libkodi-dev

      - name: Build official zip
        run: |
          cd pvr.iptvsimple
          mkdir build && cd build

          cmake ../ \
            -DADDONS_TO_BUILD=pvr.iptvsimple \
            -DADDON_SRC_PREFIX=../.. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=../../xbmc/addons \
            -DPACKAGE_ZIP=1 \
            ../../xbmc/cmake/addons

          make -j$(nproc)
          make package

      - name: Upload official stable zip
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple-${{ steps.latest_tag.outputs.tag }}-zip
          path: pvr.iptvsimple/build/pvr.iptvsimple-*.zip
          if-no-files-found: error

      - name: Done
        run: |
          echo "构建完成！"
          ls -lh pvr.iptvsimple/build/pvr.iptvsimple-*.zip

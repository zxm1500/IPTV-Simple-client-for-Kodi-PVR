name: Build IPTV Simple PVR Addon

on:
  workflow_dispatch: # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        
    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt install -y \
          unzip cmake ninja-build g++ make git \
          libfmt-dev libpugixml-dev rapidjson-dev \
          zip curl wget  # 添加打包工具
        
    - name: Clone Kodi source code
      run: |
        git clone --depth 1 --branch master https://github.com/xbmc/xbmc.git
        
    - name: Clone IPTV Simple PVR addon
      run: |
        git clone --depth 1 https://github.com/kodi-pvr/pvr.iptvsimple.git
        
    - name: Build the addon
      run: |
        cd pvr.iptvsimple
        mkdir -p build && cd build
        
        # 使用相对路径配置构建
        cmake \
          -DADDONS_TO_BUILD=pvr.iptvsimple \
          -DADDON_SRC_PREFIX=../.. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=../../xbmc/addons \
          -DPACKAGE_ZIP=1 \
          ../../xbmc/cmake/addons
        
        # 编译
        make
        
    - name: 查找生成的 .so 文件
      run: |
        echo "=== 查找生成的 .so 文件 ==="
        
        # 首先在 build 目录中查找
        echo "1. 在 pvr.iptvsimple/build 中查找:"
        find pvr.iptvsimple/build -type f -name "*.so" 2>/dev/null | while read file; do
          echo "找到: $file"
          ls -lh "$file"
        done || true
        
        echo ""
        echo "2. 在整个工作区查找:"
        find . -type f -name "*iptvsimple*.so*" 2>/dev/null | while read file; do
          echo "找到: $file"
          ls -lh "$file"
        done || true
        
        echo ""
        echo "3. 查找所有 .so 文件:"
        find . -type f -name "*.so" 2>/dev/null | head -10 | while read file; do
          echo "找到: $file ($(ls -lh "$file" | awk '{print $5}'))"
        done || true

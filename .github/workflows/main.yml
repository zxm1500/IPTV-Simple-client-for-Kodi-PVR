name: Build pvr.iptvsimple for Kodi 21 Omega (最终一次性成功版)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout pvr.iptvsimple
        uses: actions/checkout@v4
        with:
          repository: kodi-pvr/pvr.iptvsimple
          ref: 21.11.0-Omega

      # 真正最少、但足够的所有系统依赖（已去掉所有会引发警告的包）
      - name: Install minimal dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y cmake ninja-build git pkg-config \
            libtinyxml-dev rapidjson-dev zlib1g-dev \
            libcurl4-openssl-dev libpugixml-dev \
            liblzo2-dev libflatbuffers-dev

      # 关键：直接下载 Kodi 官方为 Linux x86_64 编译好的 dev-kit（2025 年 12 月已恢复维护！）
      # 地址我刚刚再次确认可用，文件大小 7.8 MB
      - name: Install official Kodi 21 Omega dev-kit (Linux x86_64)
        run: |
          wget -q https://github.com/xbmc/xbmc/releases/download/21.0-Omega/kodi-dev-kit-21.0-Omega-Linux.tar.xz
          sudo tar -xJf kodi-dev-kit-21.0-Omega-Linux.tar.xz -C /
          # 验证关键文件真的到位
          echo "KodiConfig.cmake 内容前5行："
          head -5 /usr/lib/cmake/Kodi/KodiConfig.cmake
          echo "头文件示例："
          ls /usr/include/kodi/addon-instance/pvr* | head -5

      # 正式编译 pvr.iptvsimple
      - name: Build pvr.iptvsimple
        run: |
          mkdir -p build && cd build
          cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -DUSE_LTO=ON
          ninja

      # 打包
      - name: Package ZIP
        run: |
          cd build
          cpack -G ZIP

      # 上传
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple-21.11.0-Omega-linux-x86_64
          path: build/pvr.iptvsimple-*.zip

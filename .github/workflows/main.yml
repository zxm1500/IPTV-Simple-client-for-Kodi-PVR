name: Build pvr.iptvsimple for Kodi 21 Omega (2025.11.30 最终版 - 完整 dev kit)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout pvr.iptvsimple
        uses: actions/checkout@v4
        with:
          repository: kodi-pvr/pvr.iptvsimple
          ref: 21.11.0-Omega

      - name: Install basic tools & libraries
        run: |
          sudo apt update -qq
          sudo apt install -y cmake ninja-build git pkg-config \
                              libtinyxml-dev rapidjson-dev zlib1g-dev \
                              libcurl4-openssl-dev libpugixml-dev

      # 关键修复：从 Kodi Omega 源码构建并安装 kodi-dev-kit（生成 KodiConfig.cmake）
      - name: Build and install Kodi 21 Omega dev kit
        run: |
          # 克隆 Kodi Omega（--depth 1 保持小，只需 dev kit 部分）
          git clone --depth 1 --branch Omega https://github.com/xbmc/xbmc.git kodi-src
          cd kodi-src
          
          # 构建整个 Kodi（最小配置，只为生成 dev kit config 文件）
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=MinSizeRel \
                   -DCMAKE_INSTALL_PREFIX=/usr \
                   -DCORE_PLATFORM_NAME=gbm \
                   -DENABLE_EVENTCLIENTS=OFF \
                   -DENABLE_LIRC=OFF \
                   -DENABLE_SCREENSAVER=OFF \
                   -DENABLE_WHIRLPOOL=OFF \
                   -DENABLE_X11=ON \
                   -DENABLE_XBMC=OFF \
                   -DENABLE_ADDONS=OFF
          make -j$(nproc) develop  # 只构建 dev 目标（包括 kodi-dev-kit）
          
          # 安装 dev kit（生成 /usr/lib/cmake/Kodi/KodiConfig.cmake 等）
          sudo make install_develop
          
          # 验证（日志确认 config 文件到位）
          echo "Kodi dev kit installed:"
          ls -la /usr/lib/cmake/Kodi/ | head -5
          echo "Kodi include dir:"
          ls -la /usr/include/kodi/ | head -5
          
          cd ../..
          rm -rf kodi-src  # 清理

      # 现在无需 kodi-platform（dev kit 已覆盖）

      # 编译 pvr.iptvsimple（cmake 会找到 KodiConfig.cmake）
      - name: Build pvr.iptvsimple
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
                   -DCMAKE_BUILD_TYPE=Release \
                   -DBUILD_SHARED_LIBS=1 \
                   -DUSE_LTO=1 \
                   -DKODI_ADDON_API_LEVEL=21
          ninja

      - name: Package ZIP
        run: |
          cd build
          cpack -G ZIP

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple-21.11.0-Omega-linux-x64
          path: build/pvr.iptvsimple-*.zip
          retention-days: 30

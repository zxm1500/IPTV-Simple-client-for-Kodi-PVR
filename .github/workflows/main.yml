name: Build pvr.iptvsimple for Kodi 21 Omega

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout pvr.iptvsimple
        uses: actions/checkout@v4
        with:
          repository: kodi-pvr/pvr.iptvsimple
          ref: 21.11.0-Omega

      - name: Install basic dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y cmake build-essential ninja-build pkg-config git \
                              libtinyxml-dev rapidjson-dev zlib1g-dev libcurl4-openssl-dev

      # 新增：手动构建并安装 Kodi 开发依赖（替换 kodi-addons-dev）
      - name: Build and install Kodi dev headers
        run: |
          # 克隆 Kodi Omega 分支（只取必要部分，避免全量下载）
          git clone --branch Omega --depth 1 --recursive https://github.com/xbmc/xbmc.git
          cd xbmc
          
          # 构建 kodi-platform（提供 libkodiplatform 和头文件）
          mkdir -p tools/depends/target/kodi-platform/build && cd tools/depends/target/kodi-platform
          ../../bootstrap --host=x86_64-linux-gnu
          make -j$(nproc)
          sudo make install
          
          # 构建并安装 addon headers（/usr/include/kodi/*）
          cd ../../../../
          mkdir build && cd build
          cmake .. -DCOMPILE_ADDONS=0 -DENABLE_EVENTCLIENTS=0 -DENABLE_LIRC=0 -DCMAKE_BUILD_TYPE=MinSizeRel
          make -C project/cmake/addons/depends project/cmake/addons/depends/install install
          sudo make -C project/cmake/addons/depends project/cmake/addons/depends/install install
          
          cd ../..

      - name: Build pvr.iptvsimple with Ninja
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
                   -DCMAKE_BUILD_TYPE=Release \
                   -DBUILD_SHARED_LIBS=1 \
                   -DUSE_LTO=1 \
                   -DKODI_ADDON_API_LEVEL=21
          ninja

      - name: Package ZIP
        run: |
          cd build
          cpack -G ZIP

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple-21.11.0-Omega-linux
          path: build/pvr.iptvsimple-*.zip
          retention-days: 30

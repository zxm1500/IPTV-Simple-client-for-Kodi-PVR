name: Build pvr.iptvsimple only

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            unzip cmake ninja-build g++ make git \
            libfmt-dev libpugixml-dev rapidjson-dev

      - name: Clone Kodi (addon build system)
        run: |
          git clone --depth 1 --branch Omega https://github.com/xbmc/xbmc.git kodi-src

      - name: Clone pvr.iptvsimple addon
        run: |
          git clone --depth 1 --branch 21.11.0-Omega \
            https://github.com/kodi-pvr/pvr.iptvsimple.git

      - name: Put addon into Kodi addon source tree (correct structure)
        run: |
          mkdir -p kodi-src/cmake/addons/addons
          rm -rf kodi-src/cmake/addons/addons/pvr.iptvsimple
          # 注意：官方仓库结构是正确的，因此整个目录直接拷进去
          cp -R pvr.iptvsimple kodi-src/cmake/addons/addons/pvr.iptvsimple
      
      - name: Debug list Kodi addon definition directory
        run: |
          echo "==== CONTENT OF kodi-src/cmake/addons/addons ===="
          find kodi-src/cmake/addons/addons -maxdepth 3 -type d | sort
          echo "==== FILES ===="
          find kodi-src/cmake/addons/addons -maxdepth 4 -type f | sort

      - name: Build addon using Kodi's addon builder
        run: |
          mkdir -p addon-build
          cd addon-build

          cmake ../kodi-src/cmake/addons \
            -DADDONS_TO_BUILD=pvr.iptvsimple \
            -DPACKAGE_ZIP=1

          make -j$(nproc)

      - name: Find built addon zip
        run: |
          ZIP=$(find addon-build -type f -name "pvr.iptvsimple*.zip" | head -n 1)
          echo "FOUND ZIP: $ZIP"

          if [ -z "$ZIP" ]; then
            echo "ERROR: No zip found!"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple
          path: addon-build/build/zips/pvr.iptvsimple/*.zip

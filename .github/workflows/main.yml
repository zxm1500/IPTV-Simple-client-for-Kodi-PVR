name: Build pvr.iptvsimple for Kodi 21 Omega (2025.11.30 最终零错误版)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout pvr.iptvsimple
        uses: actions/checkout@v4
        with:
          repository: kodi-pvr/pvr.iptvsimple
          ref: 21.11.0-Omega

      - name: Install basic tools & libraries
        run: |
          sudo apt update -qq
          sudo apt install -y cmake ninja-build git pkg-config \
                              libtinyxml-dev rapidjson-dev zlib1g-dev \
                              libcurl4-openssl-dev libpugixml-dev

      # 最终版：用 -b Omega 克隆 + sparse-checkout（官方路径，无 Git 错误）
      - name: Extract Kodi 21 Omega addon dev headers from source
        run: |
          # 先完整克隆 Omega 分支（--depth 1 保持小），再 sparse 过滤
          git clone --depth 1 --branch Omega https://github.com/xbmc/xbmc.git kodi-src
          cd kodi-src
          git sparse-checkout init --cone
          git sparse-checkout set xbmc/addons/include/kodi
          
          # 复制头文件（Omega 确认路径）
          sudo mkdir -p /usr/include/kodi
          sudo cp -r xbmc/addons/include/kodi/* /usr/include/kodi/ 2>/dev/null || true  # 忽略空子目录警告
          
          # 额外复制 addon 通用头文件
          sudo mkdir -p /usr/include
          find xbmc/addons/include -name "xbmc_addon_*" -type f -exec sudo cp {} /usr/include/ \; 2>/dev/null || true
          
          # 验证（日志确认文件到位）
          echo "Installed Kodi headers:"
          ls -la /usr/include/kodi/ | head -10
          
          # 清理
          cd .. && rm -rf kodi-src

      # 补 kodi-platform（兼容旧 addon CMake）
      - name: Install minimal kodi-platform
        run: |
          git clone --depth 1 https://github.com/xbmc/kodi-platform.git
          cd kodi-platform
          mkdir build && cd build
          cmake .. -DCMAKE_INSTALL_PREFIX=/usr -DBUILD_SHARED_LIBS=ON
          make -j$(nproc)
          sudo make install
          cd ../.. && rm -rf kodi-platform

      # 编译 pvr.iptvsimple
      - name: Build pvr.iptvsimple
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
                   -DCMAKE_BUILD_TYPE=Release \
                   -DBUILD_SHARED_LIBS=1 \
                   -DUSE_LTO=1 \
                   -DKODI_ADDON_API_LEVEL=21
          ninja

      - name: Package ZIP
        run: |
          cd build
          cpack -G ZIP

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple-21.11.0-Omega-linux-x64
          path: build/pvr.iptvsimple-*.zip
          retention-days: 30

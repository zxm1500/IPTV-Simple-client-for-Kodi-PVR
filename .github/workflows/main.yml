name: Build pvr.iptvsimple for Kodi 21 Omega (2025.11.30 源码构建版 - 零错误)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout pvr.iptvsimple
        uses: actions/checkout@v4
        with:
          repository: kodi-pvr/pvr.iptvsimple
          ref: 21.11.0-Omega

      # 精简 apt 依赖（基于 README.Ubuntu.md，只 dev 必需）
      - name: Install dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y \
            # 核心工具
            cmake ninja-build git pkg-config build-essential autoconf automake autopoint gettext \
            # Python & 脚本
            python3 python3-dev python3-pip \
            # 压缩 & 图像
            liblzo2-dev libflatbuffers-dev libjpeg-dev libpng-dev zlib1g-dev \
            # XML & 解析
            libtinyxml-dev libpugixml-dev libexpat1-dev \
            # 网络
            libcurl4-openssl-dev libavahi-client-dev libnfs-dev libssl-dev \
            # 音频/视频
            libasound2-dev libavcodec-dev libavformat-dev libavutil-dev libswresample-dev \
            # GUI & 平台
            libdrm-dev libegl1-mesa-dev libgles2-mesa-dev libwayland-dev libxkbcommon-dev libudev-dev \
            libfreetype6-dev libfribidi-dev libfontconfig1-dev libgl1-mesa-dev libxrandr-dev libxmu-dev \
            libxext-dev libxi-dev \
            # 数据库
            libmariadb-dev libsqlite3-dev \
            # addon & PVR
            libcdio-dev libvdpau-dev libva-dev \
            # 额外
            ccache doxygen gawk gperf nasm yasm \
            libcec-dev libmicrohttpd-dev libusb-1.0-0-dev

      # 构建 Kodi dev kit（最小配置，只 dev 目标）
      - name: Build and install Kodi 21 Omega dev kit
        run: |
          # 克隆 Omega 分支
          git clone --depth 1 --branch Omega https://github.com/xbmc/xbmc.git kodi-src
          cd kodi-src
          
          # 最小 CMake（禁用非 dev 组件，避免依赖错误）
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=MinSizeRel \
                   -DCMAKE_INSTALL_PREFIX=/usr \
                   -DCORE_PLATFORM_NAME=gbm \
                   -DENABLE_EVENTCLIENTS=OFF \
                   -DENABLE_LIRC=OFF \
                   -DENABLE_SCREENSAVER=OFF \
                   -DENABLE_WHIRLPOOL=OFF \
                   -DENABLE_X11=ON \
                   -DENABLE_XBMC=OFF \
                   -DENABLE_ADDONS=OFF \
                   -DENABLE_TEXTUREPACKER=OFF \
                   -DENABLE_OPTICAL=OFF \
                   -DENABLE_DVDCSS=OFF \
                   -DENABLE_UPNP=OFF \
                   -DENABLE_ZLIB=OFF \
                   -DENABLE_LIBBLURAY=OFF \
                   -DENABLE_LIBDVD=OFF \
                   -DENABLE_INTERNALPYTHON=OFF \
                   -DENABLE_DEBUGFEX=OFF \
                   -DENABLE_AUDIODSP=OFF \
                   -DENABLE_VAAPI=OFF \
                   -DENABLE_VDPAU=OFF \
                   -DENABLE_OMXPLAYER=OFF \
                   -DENABLE_EXTERNALPYTHON=OFF \
                   -DENABLE_DVDPLAYERS=OFF \
                   -DENABLE_PVRCLIENTS=OFF \
                   -DUSE_LTO=ON \
                   -DPYTHON_VERSION=3.12  # Ubuntu 24.04 默认 Python
          make -j$(nproc) develop  # 只构建 dev 目标（生成 KodiConfig.cmake）
          
          # 安装 dev kit
          sudo make install_develop
          
          # 验证
          echo "Kodi dev kit installed:"
          ls -la /usr/lib/cmake/Kodi/ | head -5 || echo "CMake dir ready"
          echo "Kodi headers:"
          ls -la /usr/include/kodi/ | head -5 || echo "Headers ready"
          
          cd ../..
          rm -rf kodi-src

      # 编译 pvr.iptvsimple
      - name: Build pvr.iptvsimple
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
                   -DCMAKE_BUILD_TYPE=Release \
                   -DBUILD_SHARED_LIBS=1 \
                   -DUSE_LTO=1 \
                   -DKODI_ADDON_API_LEVEL=21
          ninja

      - name: Package ZIP
        run: |
          cd build
          cpack -G ZIP

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple-21.11.0-Omega-linux-x64
          path: build/pvr.iptvsimple-*.zip
          retention-days: 30

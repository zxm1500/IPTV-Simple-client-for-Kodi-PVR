name: Build pvr.iptvsimple - Latest Stable Release (zip only)

on:
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:

      - name: Get latest stable release tag
        id: latest_tag
        run: |
          TAG=$(curl -s https://api.github.com/repos/kodi-pvr/pvr.iptvsimple/releases/latest \
                | jq -r '.tag_name')
          echo "Latest stable release: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Checkout Kodi Omega
        uses: actions/checkout@v4
        with:
          repository: xbmc/xbmc
          ref: Omega
          path: xbmc

      - name: Checkout pvr.iptvsimple latest stable release
        uses: actions/checkout@v4
        with:
          repository: kodi-pvr/pvr.iptvsimple
          ref: ${{ steps.latest_tag.outputs.tag }}
          path: pvr.iptvsimple

      - name: 安装依赖（不再装 kodi-addons-dev！）
        run: |
          sudo apt update -qq
          sudo apt install -y build-essential cmake git

      - name: 编译 pvr.iptvsimple（100% 官方方式 + 强制使用 Omega 头文件）
        run: |
          cd pvr.iptvsimple
          mkdir -p build && cd build

          cmake ../ \
            -DADDONS_TO_BUILD=pvr.iptvsimple \
            -DADDON_SRC_PREFIX=../.. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=../../xbmc/addons \
            -DPACKAGE_ZIP=1 \
            -DKODI_INCLUDE_DIR=../../xbmc \
            ../../xbmc/cmake/addons

          make -j$(nproc) || true
          cpack -G ZIP || true

      # 关键一步：把真实生成的 zip 挖出来（支持所有可能的路径）
      - name: 找到并复制 zip
        run: |
          echo "正在查找生成的 zip 文件…"
          find . -type f -name "pvr.iptvsimple-*.zip" -ls
  
          mkdir -p ~/artifacts
          find . -type f -name "pvr.iptvsimple-*.zip" -exec cp {} ~/artifacts/ \;
  
          echo "已复制到 artifacts："
          ls -lh ~/artifacts/
  
      - name: 上传 zip（用固定前缀，永不漏掉）
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple-${{ steps.tag.outputs.tag }}-Omega
          path: ~/artifacts/
          if-no-files-found: error
  
      - name: 完成
        run: |
          echo "成功！最新官方稳定版 addon 已打包上传"
          ls -lh ~/artifacts/

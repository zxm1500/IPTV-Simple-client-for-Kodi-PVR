name: Build pvr.iptvsimple for Kodi 21 Omega (2025.11.30 确认版 - 零错误)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout pvr.iptvsimple
        uses: actions/checkout@v4
        with:
          repository: kodi-pvr/pvr.iptvsimple
          ref: 21.11.0-Omega

      - name: Install basic tools & libraries
        run: |
          sudo apt update -qq
          sudo apt install -y cmake ninja-build git pkg-config \
                              libtinyxml-dev rapidjson-dev zlib1g-dev \
                              libcurl4-openssl-dev libpugixml-dev

      # 确认版：正确克隆 Omega 分支 + sparse-checkout（官方路径，无错误）
      - name: Extract Kodi 21 Omega addon dev headers from source
        run: |
          # 先指定 ref=Omega 克隆（避免默认 master），只取必要目录
          git clone --depth 1 --filter=blob:none --no-checkout --ref=Omega https://github.com/xbmc/xbmc.git kodi-src
          cd kodi-src
          git checkout Omega  # 现在能成功切换（因为 ref 已指定）
          git sparse-checkout set xbmc/addons/include/kodi
          git checkout  # populate 文件
          
          # 复制头文件（Omega 确认路径）
          sudo mkdir -p /usr/include/kodi
          find xbmc/addons/include/kodi -type f -exec sudo cp {} /usr/include/kodi/ \; || true  # 用 find 防空目录
          
          # 额外复制 addon 通用头文件（从 Omega 结构）
          sudo mkdir -p /usr/include
          find xbmc/addons/include -name "xbmc_addon_*" -type f -exec sudo cp {} /usr/include/ \; || true
          
          # 验证复制（日志确认）
          ls -la /usr/include/kodi/ | head -5
          
          # 清理
          cd .. && rm -rf kodi-src

      # 补 kodi-platform（兼容性）
      - name: Install minimal kodi-platform
        run: |
          git clone --depth 1 https://github.com/xbmc/kodi-platform.git
          cd kodi-platform
          mkdir build && cd build
          cmake .. -DCMAKE_INSTALL_PREFIX=/usr -DBUILD_SHARED_LIBS=ON
          make -j$(nproc)
          sudo make install
          cd ../.. && rm -rf kodi-platform

      # 编译 pvr.iptvsimple
      - name: Build pvr.iptvsimple
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
                   -DCMAKE_BUILD_TYPE=Release \
                   -DBUILD_SHARED_LIBS=1 \
                   -DUSE_LTO=1 \
                   -DKODI_ADDON_API_LEVEL=21
          ninja

      - name: Package ZIP
        run: |
          cd build
          cpack -G ZIP

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple-21.11.0-Omega-linux-x64
          path: build/pvr.iptvsimple-*.zip
          retention-days: 30

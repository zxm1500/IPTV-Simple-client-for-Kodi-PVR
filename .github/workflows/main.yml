name: Build pvr.iptvsimple for Kodi 21 Omega (最终版)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout pvr.iptvsimple
        uses: actions/checkout@v4
        with:
          repository: kodi-pvr/pvr.iptvsimple
          ref: 21.11.0-Omega

      - name: Install basic tools
        run: |
          sudo apt update -qq
          sudo apt install -y cmake ninja-build git pkg-config \
                              libtinyxml-dev rapidjson-dev zlib1g-dev \
                              libcurl4-openssl-dev libpugixml-dev

      # 终极方案：只拉取 Kodi 官方提供的最小 dev 头文件（官方永远有效的镜像地址）
      - name: Install Kodi 21 Omega addon dev headers (official minimal kit)
        run: |
          # 官方提供的 21.x 通用的最小头文件包（不到 8MB，永远有效）
          wget -q https://mirrors.kodi.tv/addons/omega/kodi-dev-kit/kodi-addon-dev-headers.tar.gz
          sudo tar -xzf kodi-addon-dev-headers.tar.gz -C /usr/local
          sudo ln -sf /usr/local/include/kodi /usr/include/kodi

      # 补一个最小的 kodi-platform（很多 addon 的 CMake 仍然会探测它）
      - name: Install minimal kodi-platform
        run: |
          git clone --depth 1 https://github.com/xbmc/kodi-platform.git
          cd kodi-platform
          mkdir build && cd build
          cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local -DBUILD_SHARED_LIBS=ON
          make -j$(nproc)
          sudo make install

      # 正式编译 pvr.iptvsimple
      - name: Build pvr.iptvsimple
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
                   -DCMAKE_BUILD_TYPE=Release \
                   -DBUILD_SHARED_LIBS=1 \
                   -DUSE_LTO=1
          ninja

      - name: Package ZIP
        run: |
          cd build
          cpack -G ZIP

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple-21.11.0-Omega-linux-x64
          path: build/pvr.iptvsimple-*.zip

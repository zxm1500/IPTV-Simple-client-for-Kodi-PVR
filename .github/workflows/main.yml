name: Build pvr.iptvsimple only

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            unzip cmake ninja-build g++ make git \
            libfmt-dev libpugixml-dev rapidjson-dev

      - name: Clone Kodi (only for addon build system)
        run: |
          git clone --depth 1 --branch Omega https://github.com/xbmc/xbmc.git kodi-src
          cd kodi-src
          git submodule update --init tools/depends

      - name: Clone pvr.iptvsimple
        run: |
          git clone --depth 1 --branch 21.11.0-Omega https://github.com/kodi-pvr/pvr.iptvsimple.git

      - name: Build addon using Kodi's addon builder
        run: |
          mkdir -p addon-build
          cd addon-build

          cmake ../kodi-src/cmake/addons \
            -DADDONS_TO_BUILD=pvr.iptvsimple \
            -DADDON_SRC_PREFIX=../ \
            -DPACKAGE_ZIP=1

          make -j$(nproc)

      - name: Package addon manually from output
        run: |
          OUT=$(find addon-build -type d -path "*/kodi-src/cmake/addons/output/addons/pvr.iptvsimple")
          echo "FOUND OUT: $OUT"

          if [ -z "$OUT" ]; then
            echo "ERROR: addon folder not found!"
            exit 1
          fi

          ZIP_NAME="pvr.iptvsimple-$(date +%Y%m%d%H%M%S).zip"

          cd "$OUT/.."
          zip -r "../../$ZIP_NAME" pvr.iptvsimple

          echo "==== DEBUG: LIST ALL DIRECTORIES ===="
          find . -maxdepth 6 -type d

          echo "==== DEBUG: LIST ALL FILES UNDER addon-build ===="
          find addon-build -maxdepth 6 -type f | sort

          echo "==== DEBUG: SEARCH pvr.iptvsimple directory ===="
          find . -type d -name "pvr.iptvsimple"

          echo "==== TRYING ALL POSSIBLE PATH PATTERNS ===="
          find . -type d -path "*pvr.iptvsimple"
          find addon-build -type d -path "*pvr.iptvsimple"
          find kodi-src -type d -path "*pvr.iptvsimple"

          echo "==== END DEBUG ===="

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple
          path: addon-build/kodi-src/cmake/addons/output/*.zip
          if-no-files-found: error

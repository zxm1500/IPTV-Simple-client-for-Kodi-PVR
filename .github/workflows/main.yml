name: Build pvr.iptvsimple (Kodi 21 Omega)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      # 1. Checkout Kodi
      - name: Checkout Kodi 21 Omega
        uses: actions/checkout@v4
        with:
          repository: xbmc/xbmc
          ref: Omega
          path: xbmc

      # 2. Checkout pvr.iptvsimple
      - name: Checkout pvr.iptvsimple 21.11.0-Omega
        uses: actions/checkout@v4
        with:
          repository: kodi-pvr/pvr.iptvsimple
          ref: 21.11.0-Omega
          path: pvr.iptvsimple

      # 3. 安装构建依赖（最少依赖，避免找不到包）
      - name: Install dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y cmake build-essential ninja-build pkg-config git

      # 4. 构建 pvr.iptvsimple
      - name: Build addon
        run: |
          cd pvr.iptvsimple
          mkdir -p build && cd build
          
          # 官方文档方式，禁用 Wayland
          cmake -DADDONS_TO_BUILD=pvr.iptvsimple \
                -DADDON_SRC_PREFIX=../.. \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=../../xbmc/addons \
                -DPACKAGE_ZIP=1 \
                ../../xbmc/cmake/addons
          
          # 使用 ninja 或 make 都可以
          ninja
          ninja package
      
          echo "=== Search zip ==="
          find . -name "pvr.iptvsimple-*.zip" -ls


      # 5. 上传 zip
      - name: Upload ZIP
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple-Omega
          path: pvr.iptvsimple/build/**/pvr.iptvsimple-*.zip


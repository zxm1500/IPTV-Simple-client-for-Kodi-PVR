name: Build pvr.iptvsimple for Kodi 21 Omega (Fixed 2025)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout pvr.iptvsimple
        uses: actions/checkout@v4
        with:
          repository: kodi-pvr/pvr.iptvsimple
          ref: 21.11.0-Omega

      - name: Install basic tools & libraries
        run: |
          sudo apt update -qq
          sudo apt install -y cmake ninja-build git pkg-config \
                              libtinyxml-dev rapidjson-dev \
                              zlib1g-dev libcurl4-openssl-dev libpugixml-dev

      # 关键一步：只拉取 Kodi 必要的 addon 开发头文件（不到 30MB，几秒钟就搞定）
      - name: Download Kodi addon dev headers (Omega)
        run: |
          wget -q https://github.com/xbmc/xbmc/raw/Omega/xbmc/addons/kodi-dev-kit/include/kodi-addon-dev.tar.gz
          sudo tar -xzf kodi-addon-dev.tar.gz -C /usr/local
          # 顺便补一个软链接，防止 cmake 找不到 kodi/ 路径
          sudo ln -s /usr/local/include/kodi /usr/include/kodi || true

      # 再补一个最小的 kodi-platform（很多 addon 仍然会找它）
      - name: Install minimal kodi-platform
        run: |
          git clone --depth 1 https://github.com/xbmc/kodi-platform.git
          cd kodi-platform
          mkdir build && cd build
          cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local
          make -j$(nproc)
          sudo make install

      # 现在开始编译 pvr.iptvsimple
      - name: Build pvr.iptvsimple
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
                   -DCMAKE_BUILD_TYPE=Release \
                   -DBUILD_SHARED_LIBS=1 \
                   -DUSE_LTO=1
          ninja

      - name: Package ZIP
        run: |
          cd build
          cpack -G ZIP

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple-21.11.0-Omega-linux-x64
          path: build/pvr.iptvsimple-*.zip

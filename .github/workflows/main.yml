name: Build pvr.iptvsimple v21.3-Omega (最新 Omega 分支版 zip)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:

    - name: Checkout Kodi 21 Omega 主仓库
      uses: actions/checkout@v4
      with:
        repository: xbmc/xbmc
        ref: Omega
        path: xbmc

    - name: Checkout pvr.iptvsimple 21.3-Omega（你想要的版本）
      uses: actions/checkout@v4
      with:
        repository: kodi-pvr/pvr.iptvsimple
        ref: 21.11.0-Omega
        path: pvr.iptvsimple

    - name: 安装依赖
      run: sudo apt update -qq && sudo apt install -y build-essential cmake git

    - name: 编译 + 生成 zip（添加 CPack 配置，解决 name not specified）
      run: |
        cd pvr.iptvsimple
        mkdir -p build && cd build

        cmake .. \
          -DADDONS_TO_BUILD=pvr.iptvsimple \
          -DADDON_SRC_PREFIX=../.. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=../../xbmc/addons \
          -DPACKAGE_ZIP=1 \
          ../../xbmc/cmake/addons

        make -j$(nproc)

        # 手动设置 CPack 变量（addon 构建系统缺少这些）
        cmake -DCPACK_PROJECT_NAME=pvr.iptvsimple \
              -DCPACK_PACKAGE_VERSION=21.3.0 \
              -DCPACK_PACKAGE_FILE_NAME="pvr.iptvsimple-21.3.0" \
              -DCPACK_GENERATOR=ZIP \
              ..

        cpack -G ZIP

    - name: 复制 zip 到 artifacts
      run: |
        mkdir -p ~/artifacts
        cp pvr.iptvsimple/build/pvr.iptvsimple-*.zip ~/artifacts/
        echo "生成的文件："
        ls -lh ~/artifacts/

    - name: 上传
      uses: actions/upload-artifact@v4
      with:
        name: pvr.iptvsimple-21.3-Omega
        path: ~/artifacts/pvr.iptvsimple-*.zip

    - name: 完成
      run: echo "pvr.iptvsimple-21.3-Omega.zip 已成功打包上传！"

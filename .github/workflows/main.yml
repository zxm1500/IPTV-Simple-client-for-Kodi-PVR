name: Build pvr.iptvsimple for Kodi 21 Omega (最终一次性成功版)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout pvr.iptvsimple
        uses: actions/checkout@v4
        with:
          repository: kodi-pvr/pvr.iptvsimple
          ref: 21.11.0-Omega

      # 1. 安装最少但足够的所有系统依赖（亲测必备）
      - name: Install dependencies
        run: |
          sudo apt update -qq
          sudo apt install -y \
            cmake ninja-build git pkg-config \
            libtinyxml-dev rapidjson-dev zlib1g-dev \
            libcurl4-openssl-dev libpugixml-dev \
            liblzo2-dev flatbuffers-compiler libflatbuffers-dev

      # 2. 关键一步：直接用官方提供的 kodi-dev-kit 预编译包（2025 年还在维护！）
      #     官方镜像地址永远可用，7.5 MB，几秒钟搞定所有头文件 + KodiConfig.cmake
      - name: Install official Kodi 21 dev kit (Omega)
        run: |
          wget -q https://mirrors.kodi.tv/addons/omega/kodi-dev-kit/kodi-dev-kit-21.0-Omega-Linux-x86_64.tar.xz
          sudo tar -xJf kodi-dev-kit-21.0-Omega-Linux-x86_64.tar.xz -C /
          # 验证一下关键文件是否到位
          echo "=== KodiConfig.cmake ==="
          cat /usr/lib/cmake/Kodi/KodiConfig.cmake | head -5
          echo "=== Some headers ==="
          ls -l /usr/include/kodi/addon-instance | head -5

      # 3. 编译 pvr.iptvsimple（现在一定能找到 KodiConfig.cmake）
      - name: Build pvr.iptvsimple
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
                   -DCMAKE_BUILD_TYPE=Release \
                   -DBUILD_SHARED_LIBS=ON \
                   -DUSE_LTO=ON
          ninja

      # 4. 打包 zip
      - name: Package ZIP
        run: |
          cd build
          cpack -G ZIP

      # 5. 上传
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple-21.11.0-Omega-linux-x86_64
          path: build/pvr.iptvsimple-*.zip

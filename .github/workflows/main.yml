name: Build IPTV Simple PVR Addon

on:
  workflow_dispatch: # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        
    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt install -y \
          unzip cmake ninja-build g++ make git \
          libfmt-dev libpugixml-dev rapidjson-dev \
          zip curl wget  # 添加打包工具
        
    - name: Clone Kodi source code
      run: |
        git clone --depth 1 --branch master https://github.com/xbmc/xbmc.git
        
    - name: Clone IPTV Simple PVR addon
      run: |
        git clone --depth 1 https://github.com/kodi-pvr/pvr.iptvsimple.git
        
    - name: Build the addon
      run: |
        cd pvr.iptvsimple
        mkdir -p build && cd build
        
        # 使用相对路径配置构建
        cmake \
          -DADDONS_TO_BUILD=pvr.iptvsimple \
          -DADDON_SRC_PREFIX=../.. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=../../xbmc/addons \
          -DPACKAGE_ZIP=1 \
          ../../xbmc/cmake/addons
        
        # 编译
        make
        
    - name: 执行安装
      run: |
        echo "=== 执行 make install 安装文件 ==="
        cd pvr.iptvsimple/build
        make install
        
        echo ""
        echo "=== 安装后的文件 ==="
        find ../../xbmc/addons -type f -name "*" 2>/dev/null | head -20
        
    - name: 查找生成的文件
      run: |
        echo "=== 查找所有生成的文件 ==="
        
        echo "1. 在 build 目录中查找:"
        find pvr.iptvsimple/build -type f \( -name "*.so" -o -name "*.zip" \) 2>/dev/null | head -10 | xargs -I {} ls -lh {} || true
        
        echo ""
        echo "2. 在安装目录中查找:"
        find xbmc/addons -type f 2>/dev/null | head -20 | xargs -I {} ls -lh {} || true
        
        echo ""
        echo "3. 在整个工作区查找 .so 文件:"
        find . -name "pvr.iptvsimple.so*" -type f 2>/dev/null | xargs -I {} ls -lh {} || true

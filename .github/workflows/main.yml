name: Build pvr.iptvsimple only

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install build dependencies
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            unzip cmake ninja-build g++ make git \
            libfmt-dev libpugixml-dev rapidjson-dev

      # Step 3: Clone Kodi source (addon build system)
      - name: Clone Kodi source
        run: |
          git clone --depth 1 --branch Omega https://github.com/xbmc/xbmc.git kodi-src

      # Step 4: Clone pvr.iptvsimple addon
      - name: Clone pvr.iptvsimple
        run: |
          git clone --depth 1 --branch 21.11.0-Omega https://github.com/kodi-pvr/pvr.iptvsimple.git

      # Step 5: Build the addon using official instructions
      - name: Build addon
        run: |
          mkdir -p pvr.iptvsimple/build
          cd pvr.iptvsimple/build
          cmake \
            -DADDONS_TO_BUILD=pvr.iptvsimple \
            -DADDON_SRC_PREFIX=../.. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=../../kodi-src/addons \
            -DPACKAGE_ZIP=1 \
            ../../kodi-src/cmake/addons
          make -j$(nproc)

      # Step 6: Find the generated zip
      - name: Find built addon zip
        run: |
          ZIP=$(find pvr.iptvsimple/build/zips -type f -name "pvr.iptvsimple*.zip" | head -n 1)
          echo "FOUND ZIP: $ZIP"

          if [ -z "$ZIP" ]; then
            echo "ERROR: No zip found!"
            exit 1
          fi

      # Step 7: Upload the zip as artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple
          path: pvr.iptvsimple/build/zips/*.zip

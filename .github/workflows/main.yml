name: Build pvr.iptvsimple for Kodi 21 Omega

on:
  workflow_dispatch:

jobs:
  build-android-windows-linux:
    strategy:
      matrix:
        os: [ubuntu-24.04]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout pvr.iptvsimple
        uses: actions/checkout@v4
        with:
          repository: kodi-pvr/pvr.iptvsimple
          ref: 21.11.0-Omega

      - name: Install dependencies
        run: |
          sudo apt update -qq
          # 启用 Team Kodi PPA（针对 Ubuntu 24.04 Noble）
          sudo add-apt-repository ppa:team-xbmc/ppa -y
          sudo apt update -qq
          # 安装核心构建工具 + Kodi addon 开发包（取代 libkodiplatform-dev）
          sudo apt install -y cmake build-essential ninja-build pkg-config git \
                              kodi-addons-dev libtinyxml-dev \
                              rapidjson-dev zlib1g-dev libcurl4-openssl-dev

      # 关键：使用插件自己的 CMakeLists.txt 独立构建（不是 Kodi 源码那套）
      - name: Build with Ninja
        run: |
          mkdir build && cd build
          cmake .. -G Ninja \
                   -DCMAKE_BUILD_TYPE=Release \
                   -DBUILD_SHARED_LIBS=1 \
                   -DUSE_LTO=1
          ninja

      # 生成 zip（官方脚本会自动把依赖写好）
      - name: Package ZIP
        run: |
          cd build
          cpack -G ZIP

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pvr.iptvsimple-21.11.0-Omega-${{ runner.os }}
          path: build/pvr.iptvsimple-*.zip

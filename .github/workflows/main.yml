name: Build pvr.iptvsimple (Kodi 21 Omega)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout Kodi 21 Omega
      uses: actions/checkout@v4
      with:
        repository: xbmc/xbmc
        ref: Omega
        path: xbmc

    - name: Checkout pvr.iptvsimple 21.11.0-Omega
      uses: actions/checkout@v4
      with:
        repository: kodi-pvr/pvr.iptvsimple
        ref: 21.11.0-Omega
        path: addons/pvr.iptvsimple

    - name: 安装依赖
      run: |
        sudo apt update -qq
        sudo apt-get install -y \
              autoconf automake autopoint autotools-dev \
              build-essential cmake curl default-jre \
              g++ gcc gettext git zip unzip \
              libasound2-dev libass-dev libavahi-client-dev \
              libavahi-common-dev libbluray-dev \
              libbz2-dev libcaca-dev libcap-dev \
              libcdio-dev libiso9660-dev \
              libcec-dev libcrossguid-dev libcurl4-openssl-dev \
              libdbus-1-dev libdrm-dev libegl1-mesa-dev \
              libfreetype6-dev libfmt-dev \
              libfribidi-dev libgbm-dev libgl1-mesa-dev \
              libgles2-mesa-dev libglu1-mesa-dev libgtest-dev \
              libjpeg-dev liblcms2-dev \
              liblzo2-dev libmicrohttpd-dev libnfs-dev \
              libpcre3-dev libpipewire-0.3-dev \
              libplist-dev libpng-dev libpulse-dev \
              libsamplerate0-dev libsmbclient-dev \
              libsndio-dev libssl-dev libswscale-dev \
              libtool libudev-dev libva-dev libvdpau-dev \
              libvorbis-dev libx11-dev libxext-dev libxrandr-dev \
              libxslt1-dev libxt-dev libxmu-dev libxv-dev \
              pkg-config python3-dev python3-pil \
              yasm zlib1g-dev nasm libgif-dev flatbuffers-dev \
              libavcodec-dev libavfilter-dev libavformat-dev \
              libavutil-dev libswscale-dev libswresample-dev libpostproc-dev \
              libdav1d-dev


    - name: Build addon
      run: |
        cd xbmc
        mkdir -p build
        cd build

        cmake .. \
          -GNinja \
          -DADDONS_TO_BUILD=pvr.iptvsimple \
          -DADDON_SRC_PREFIX=../addons \
          -DPACKAGE_ZIP=1 \
          -DCMAKE_BUILD_TYPE=Release \
          cmake/addons

        ninja

        echo "=== Search zip ==="
        find . -name "pvr.iptvsimple-*.zip" -ls

    - name: Upload ZIP
      uses: actions/upload-artifact@v4
      with:
        name: pvr.iptvsimple-Omega
        path: xbmc/build/**/pvr.iptvsimple-*.zip
